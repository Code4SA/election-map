function update_map(e,t,n,r){var i=mapg.select("g#c4sa_areas"),s=mapg.select("g#c4sa_borders"),o=topojson.feature(e,e.objects.demarcation).features;for(var u=0;u<o.length;u++){var a=o[u].id;for(var f=0;f<t.length;f++)if(t[f][n]==a){o[u].properties.results=t[f].results;o[u].properties.winner=calc_winners(t[f].results.vote_count);o[u].properties.winner.perc=o[u].properties.winner.vote_count/t[f].results.meta.total_votes}}i.selectAll("."+r).remove();var l=i.selectAll("."+r).data(o);l.enter().append("path").attr("class",function(e){return r+" "+e.id+" demarc-level-"+level}).style("fill",function(e){return e.properties.winner?d3.hsl(colors[e.properties.winner.party],.6,linear_scale(e.properties.winner.perc)).rgb():"#444"}).attr("data-level",function(e){return e.properties.Level}).attr("id",function(e){return e.id}).attr("d",path).on("click",zoomin).on("mousemove",hovered).on("mouseout",unhovered);s.selectAll("."+r+"-border").remove();var c=s.append("path").datum(topojson.mesh(e,e.objects.demarcation,function(e,t){return e!==t})).attr("class","border "+r+"-border border-level-"+level).attr("d",path).style("stroke-width","0.1px")}function progressive_load(e){var t=mapg.select("g#c4sa_areas");if(level==1){var n=d3.json(mapurl+"municipality?quantization=3000&filter[PROVINCE]="+e.id),r=d3.json(apiurl+"2009/municipality/?all_results=true&province="+e.id);queue().defer(n.get).defer(r.get).await(function(n,r,i){t.selectAll("."+e.id).style("display","none");i=i.results;update_map(r,i,"municipality_id","municipality")})}if(level==2){t.selectAll(".demarc-level-2").remove();borderg.selectAll(".border-level-2").remove();var i=d3.json(mapurl+"ward?quantization=3000&filter[CAT_B]="+e.id),s=d3.json(apiurl+"2009/ward/?all_results=true&municipality="+e.id);queue().defer(i.get).defer(s.get).await(function(n,r,i){t.selectAll("."+e.id).style("display","none");t.selectAll("."+e.properties.PROVINCE).style("display","none");i=i.results;update_map(r,i,"ward_id","ward")})}}function reset_displayed(){var e=mapg.select("g#c4sa_areas");e.selectAll(".province").style("display","inherit");e.selectAll(".municipality").style("display","inherit")}function zoomin(e){curElem=e;level=e.properties.Level+1;if(level==3)return;reset_displayed();progressive_load(e);level>0&&d3.select("#c4sa_zoomout").style("display","inline");var t,n,r,i,s,o,u,a=path.centroid(e);t=a[0];n=a[1];var f=path.bounds(e);r=f[1][0]-f[0][0];i=f[1][1]-f[0][1];s=.9/Math.max(r/width,i/height);mapg.transition().duration(750).attr("transform","translate("+width/2+","+height/2+")scale("+s+")translate("+ -t+","+ -n+")");mapg.attr("class","level-"+level)}function zoomout(){reset_displayed();if(level==1){mapg.transition().duration(750).attr("transform","translate(0,0)scale(1)");level=0;mapg.attr("class","level-"+level);d3.selectAll(".municipality").style("display","none");d3.selectAll(".ward").style("display","none");d3.select("#c4sa_zoomout").style("display","none")}else if(level==2){province=curElem.properties.PROVINCE;el=d3.select("#"+province);zoomin(el.data()[0])}else if(level==3){munic=curElem.properties.CAT_B;el=d3.select("#"+munic);zoomin(el.data()[0])}}function calc_winners(e){var t=[],n={},r=0,i=0;for(var s in e)if(e[s]>r){r=e[s];n={party:s,vote_count:e[s]}}return n}function sort_votes(e){var t=[];for(party in e)t.push([party,e[party]]);t.sort(function(e,t){return t[1]-e[1]});return t}function hovered(e){if(!hovering){hoverph.append("path").attr("d",d3.select(this).attr("d")).attr("id","c4sa_hoverobj");hovering=!0;var t="";e.properties.Level==0?t=e.properties.PROVINCE:e.properties.Level==1?t=e.properties.MUNICNAME+", "+e.properties.PROVINCE:t="Ward "+e.properties.WARDNO+", "+e.properties.MUNICNAME;var n=e.properties.results,r=e.properties.winner;d3.select("#c4sa_hoverblurb").text(r.party+" "+Math.round(r.perc*100)+"%");d3.select("#c4sa_hovername").text(e.id);d3.select("#c4sa_demarcation_title").text(t);var i=d3.format(","),s=d3.format(".2%");d3.select("#c4sa_section_24a_votes").text(i(e.properties.results.meta.section_24a_votes));d3.select("#c4sa_num_registered").text(i(e.properties.results.meta.num_registered));d3.select("#c4sa_special_votes").text(i(e.properties.results.meta.special_votes));d3.select("#c4sa_spoilt_votes").text(i(e.properties.results.meta.spoilt_votes));d3.select("#c4sa_total_votes").text(i(e.properties.results.meta.total_votes));var o=e.properties.results.meta.total_votes;d3.select("#c4sa_vote_results").html("");var u=d3.select("#c4sa_vote_results").selectAll("tr").data(sort_votes(e.properties.results.vote_count)),a=u.enter().append("tr").attr("class",function(e){return"party row-"+e[0].replace(/\s/g,"_").toLowerCase()});a.append("td").text(function(e){return e[0]});a.append("td").text(function(e){return i(e[1])});a.append("td").text(function(e){return s(e[1]/o)})}}function unhovered(e){d3.select("#c4sa_hovername").text("");d3.select("#c4sa_hoverobj").remove();hovering=!1}var Code4SA={};Code4SA.Framework=function(e,t,n){var r={bindToElementId:"code4sa",project:"test",apiKey:""},i=null,s=function(){i=t.getElementById(r.bindToElementId);Code4SA.template.render(i)};return{deploy:function(e){s();r.project=e;i.className+="code4sa_deploy";Code4SA.app.init()}}}(this,this.document);var apiurl="http://localhost:5000/national/",mapurl="http://localhost:8080/political/",provinceurl=apiurl+"2009/province/",municipalurl=apiurl+"2009/municipality/?all_results=true",wardurl=apiurl+"2009/ward/?all_results=true",width=500,height=450,curCode="",curBallot="",curElem,history=[],projection=d3.geo.conicEqualArea().center([0,-28.5]).rotate([-24.5,0]).parallels([-25.5,-31.5]).scale(1800).translate([width/2,height/2]),path=d3.geo.path().projection(projection),svg=d3.select("div#c4sa_map").select("svg");svg.attr("viewBox","0 0 "+width+" "+height);var mapg=svg.select("g#c4sa_map"),selph=mapg.select("g#c4sa_selph"),hoverph=mapg.select("g#c4sa_hoverph"),borderg=mapg.select("g#c4sa_borders"),province_job=d3.json(mapurl+"province?quantization=5000"),province_data_job=d3.json(provinceurl),municipal_data_job=d3.json(municipalurl),ward_data_job=d3.json(wardurl),level=0,levels=["province","municipality","ward"],levels_zoom=[1,4,15],wardscache={},linear_scale=d3.scale.linear().domain([1,0]),colors={"AFRICAN NATIONAL CONGRESS":30,"DEMOCRATIC ALLIANCE":190,"INKATHA FREEDOM PARTY":270,"INDEPENDENT DEMOCRATS":60,"CONGRESS OF THE PEOPLE":90,"UNITED DEMOCRATIC MOVEMENT":170};queue().defer(province_job.get).defer(province_data_job.get).await(function(e,t,n){n=n.results;update_map(t,n,"province_id","province")});d3.select("#c4sa_zoomout").on("click",zoomout);var hovering=!1;